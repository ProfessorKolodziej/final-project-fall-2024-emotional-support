<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>音乐播放 - 情绪支持应用</title>
    <link rel="stylesheet" href="css/music_player.css">
    <link rel="stylesheet" href="css/responsive.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <script src="js/storage.js"></script>
</head>
<body>
    <div class="header">
        <div style="display: flex; align-items: center;">
            <a id="back-link" href="emotion.html?type=happy" class="back-button">
                <i class="fas fa-arrow-left"></i>
            </a>
            <div id="song-title" class="song-title">音乐播放</div>
        </div>
        <div class="more-options">
            <i class="fas fa-ellipsis-v"></i>
        </div>
    </div>
    
    <div class="player-container">
        <div class="album-art">
            <img id="album-cover" src="./images/bt.jpg" alt="Album cover">
        </div>
        
        <div class="song-info">
            <div id="song-name" class="song-name">加载中...</div>
            <div id="artist-name" class="artist-name">加载中...</div>
        </div>
        
        <div class="progress-container">
            <div class="progress-bar">
                <div id="progress" class="progress"></div>
            </div>
            <div class="time-info">
                <div id="current-time" class="current-time">0:00</div>
                <div id="total-time" class="total-time">0:00</div>
            </div>
        </div>
        
        <div class="controls">
            <div id="prev-button" class="control-button previous">
                <i class="fas fa-backward"></i>
            </div>
            <div id="play-button" class="play-button">
                <i id="play-icon" class="fas fa-play"></i>
            </div>
            <div id="next-button" class="control-button next">
                <i class="fas fa-forward"></i>
            </div>
        </div>
        
        <div class="bottom-actions">
            <div id="favorite-button" class="action-button favorite">
                <i class="far fa-heart"></i>
            </div>
        </div>
    </div>
    
    <div id="playlist-container"></div>
    
    <audio id="audio-player"></audio>
    
    <script>
        
        function getUrlParams() {
            const params = new URLSearchParams(window.location.search);
            return {
                type: params.get('type') || 'happy',
                index: parseInt(params.get('index') || '0')
            };
        }
        
        
        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins}:${secs < 10 ? '0' : ''}${secs}`;
        }
        
        
        let currentEmotion = 'happy';
        let currentSongs = [];
        let currentIndex = 0;
        let isPlaying = false;
        
        
        const audioPlayer = document.getElementById('audio-player');
        const playButton = document.getElementById('play-button');
        const playIcon = document.getElementById('play-icon');
        const prevButton = document.getElementById('prev-button');
        const nextButton = document.getElementById('next-button');
        const progress = document.getElementById('progress');
        const currentTimeEl = document.getElementById('current-time');
        const totalTimeEl = document.getElementById('total-time');
        const albumCover = document.getElementById('album-cover');
        const songName = document.getElementById('song-name');
        const artistName = document.getElementById('artist-name');
        const songTitle = document.getElementById('song-title');
        const favoriteButton = document.getElementById('favorite-button');
        const backLink = document.getElementById('back-link');
        const playlistContainer = document.getElementById('playlist-container');
        
        
        function togglePlay() {
            if (isPlaying) {
                audioPlayer.pause();
                playIcon.classList.remove('fa-pause');
                playIcon.classList.add('fa-play');
            } else {
                audioPlayer.play();
                playIcon.classList.remove('fa-play');
                playIcon.classList.add('fa-pause');
            }
            isPlaying = !isPlaying;
        }
        
        
        function playPrevious() {
            if (currentIndex > 0) {
                currentIndex--;
                loadSong();
            }
        }
        
        
        function playNext() {
            if (currentIndex < currentSongs.length - 1) {
                currentIndex++;
                loadSong();
            }
        }
        
        
        function updateProgress() {
            const percent = (audioPlayer.currentTime / audioPlayer.duration) * 100;
            progress.style.width = `${percent}%`;
            currentTimeEl.textContent = formatTime(audioPlayer.currentTime);
        }
        
        
        function setProgress(e) {
            const width = this.clientWidth;
            const clickX = e.offsetX;
            const duration = audioPlayer.duration;
            audioPlayer.currentTime = (clickX / width) * duration;
        }
        
        
        function loadSong() {
            if (currentSongs.length <= 0 || currentIndex < 0 || currentIndex >= currentSongs.length) {
                return;
            }
            
            const song = currentSongs[currentIndex];
            
            
            const newUrl = `music_player.html?type=${currentEmotion}&index=${currentIndex}`;
            window.history.replaceState({}, '', newUrl);
            
            
            songName.textContent = song.title;
            artistName.textContent = song.artist;
            songTitle.textContent = song.title;
            albumCover.src = song.coverSrc;
            
            
            audioPlayer.src = song.audioSrc;
            
            
            totalTimeEl.textContent = song.duration;
            
            
            if (isPlaying) {
                audioPlayer.play();
            }
            
            
            backLink.href = `emotion.html?type=${currentEmotion}`;
            
            
            updatePlaylistHighlight();
            
            
            updateFavoriteButton(song);
        }
        
        
        function updateFavoriteButton(song) {
            const songData = {
                title: song.title,
                artist: song.artist,
                cover: song.coverSrc
            };
            
            const isSaved = isItemSaved('savedSongs', songData);
            const icon = favoriteButton.querySelector('i');
            
            if (isSaved) {
                icon.classList.remove('far');
                icon.classList.add('fas');
            } else {
                icon.classList.remove('fas');
                icon.classList.add('far');
            }
        }
        
        
        function showToast(message) {
            
            let toast = document.querySelector('.toast');
            
            if (!toast) {
                toast = document.createElement('div');
                toast.className = 'toast';
                document.body.appendChild(toast);
            }
            
            
            toast.textContent = message;
            toast.classList.add('show');
            
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 2000);
        }
        
        
        function loadPlaylist() {
            playlistContainer.innerHTML = '';
            
            if (currentSongs.length <= 0) {
                return;
            }
            
            currentSongs.forEach((song, index) => {
                if (index === currentIndex) return;
                
                const playlistItem = document.createElement('div');
                playlistItem.className = 'playlist-item';
                playlistItem.dataset.index = index;
                
                playlistItem.innerHTML = `
                    <div class="playlist-image">
                        <img src="${song.coverSrc}" alt="${song.title}">
                    </div>
                    <div class="playlist-info">
                        <div class="playlist-title">${song.title}</div>
                        <div class="playlist-artist">${song.artist}</div>
                    </div>
                    <div class="playlist-more">
                        <i class="fas fa-ellipsis-v"></i>
                    </div>
                `;
                
                playlistItem.addEventListener('click', () => {
                    currentIndex = index;
                    loadSong();
                    isPlaying = false;
                    togglePlay();
                });
                
                playlistContainer.appendChild(playlistItem);
            });
        }
        
       
        function updatePlaylistHighlight() {
            const playlistItems = document.querySelectorAll('.playlist-item');
            playlistItems.forEach(item => {
                const index = parseInt(item.dataset.index);
                if (index === currentIndex) {
                    item.classList.add('active');
                } else {
                    item.classList.remove('active');
                }
            });
        }
        
        
        function initMusicPlayer() {
            
            const params = getUrlParams();
            currentEmotion = params.type;
            currentIndex = params.index;
            
            
            fetch('./emotions.json')
                .then(response => response.json())
                .then(data => {
                    const emotionData = data[currentEmotion];
                    if (!emotionData) {
                        console.error('Emotion type not found');
                        return;
                    }
                    
                    currentSongs = emotionData.sections.music.items;
                    document.title = emotionData.title + ' - 音乐播放 - 情绪支持应用';
                    
                    
                    document.documentElement.style.setProperty('--primary-color', emotionData.primaryColor);
                    document.documentElement.style.setProperty('--secondary-color', emotionData.secondaryColor);
                    
                    
                    loadSong();
                    
                    
                    loadPlaylist();
                })
                .catch(error => {
                    console.error('Error loading emotion data:', error);
                });
        }
        
        
        playButton.addEventListener('click', togglePlay);
        prevButton.addEventListener('click', playPrevious);
        nextButton.addEventListener('click', playNext);
        
        audioPlayer.addEventListener('timeupdate', updateProgress);
        audioPlayer.addEventListener('ended', playNext);
        
        document.querySelector('.progress-bar').addEventListener('click', setProgress);
        
        favoriteButton.addEventListener('click', function() {
            const icon = this.querySelector('i');
            const song = currentSongs[currentIndex];
            
            
            const songData = {
                title: song.title,
                artist: song.artist,
                cover: song.coverSrc
            };
            
            if (icon.classList.contains('far')) {
                
                if (saveItem('savedSongs', songData)) {
                    
                    icon.classList.remove('far');
                    icon.classList.add('fas');
                    
                   
                    showToast('Song saved successfully!');
                }
            } else {
                
                const savedSongs = JSON.parse(localStorage.getItem('savedSongs') || '[]');
                const songIndex = savedSongs.findIndex(s => 
                    s.title === songData.title && s.artist === songData.artist
                );
                
                if (songIndex !== -1 && removeItem('savedSongs', songIndex)) {
                    
                    icon.classList.remove('fas');
                    icon.classList.add('far');
                    
                    
                    showToast('Song removed from saved items');
                }
            }
        });
        
        
        window.onload = function() {
            initMusicPlayer();
            
        };
        
    </script>
</body>
</html> 